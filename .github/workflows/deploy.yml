name: CI/CD

on:
  push:
    branches:
      - development
      - main

jobs:
  deploy:
    name: Deploy app
    environment: 
      name: ${{ github.ref == 'refs/heads/development' && 'staging' || 'prod' }}
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: Set environment variable STAGE
        run: echo "STAGE=$(if [[ "${{ github.ref }}" == 'refs/heads/development' ]]; then echo staging; elif [[ "${{ github.ref }}" == 'refs/heads/main' ]]; then echo prod; fi)" >> $GITHUB_ENV
      
      - name: Set outputs
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Check outputs
        run: echo ${{ steps.vars.outputs.sha_short }}

      - name: executing remote ssh commands using password
        uses: appleboy/ssh-action@master
        with:
          host: ${{ vars.SSH_HOST }}
          username: ${{ vars.SSH_USER }}
          key: ${{ vars.SSH_KEY }}
          script: |
            echo $GITHUB_SHA
            pwd
            cd /var/www/bonzo && ls -la && mkdir ${{ steps.vars.outputs.sha_short }} && ls -la

      - name: copy file via ssh password
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ vars.SSH_HOST }}
          username: ${{ vars.SSH_USER }}
          key: '${{ vars.SSH_KEY }}'
          source: "*"
          target: /var/www/bonzo/releases/${{ steps.vars.outputs.sha_short }}

      # - name: ssh scp ssh pipelines
      #   uses: cross-the-world/ssh-scp-ssh-pipelines@latest
      #   env:
      #     WELCOME: "ssh scp ssh pipelines"
      #     LASTSSH: "Doing something after copying"
      #   with:
      #     host: '${{ vars.SSH_HOST }}'
      #     user: '${{ vars.SSH_USER }}'
      #     key: '${{ vars.SSH_KEY }}'
      #     first_ssh: |
      #       ls -la  /var/www/bonzo
      #       mkdir /var/www/bonzo/releases/$GITHUB_SHA
      #     scp: |
      #       './.github/workflows/*' => /var/www/bonzo/releases/$GITHUB_SHA
      #       './templates/index.html' => /var/www/bonzo/releases/$GITHUB_SHA
      #       'README.md' => /var/www/bonzo/releases/$GITHUB_SHA
      #     last_ssh: |
      #       ls -la /var/www/bonzo/releases/$GITHUB_SHA

